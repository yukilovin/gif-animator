<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GIF Animator（ズレ修正版）</title>
<style>
  body{margin:0;background:#fff;color:#111827;font-family:sans-serif;height:100vh;display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;box-sizing:border-box}
  aside{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;overflow:auto}
  main{display:flex;flex-direction:column;align-items:center}
  #canvas{background:#fff;border:2px solid #000;touch-action:none;display:block;margin-top:10px}
  #timeline{width:100%;display:block;border:1px solid #e5e7eb;background:#f9fafb}
  .marquee{position:absolute;border:1px dashed #60a5fa;background:rgba(59,130,246,.1);pointer-events:none}
</style>
</head>
<body>
  <aside>
    <h1>設定</h1>
  </aside>
  <main>
    <h1>GIF Animator</h1>
    <div id="marquee" class="marquee" style="display:none"></div>
    <canvas id="canvas" width="1080" height="1080"></canvas>
    <div id="coordReadout">X:0 Y:0</div>
    <canvas id="timeline" height="220"></canvas>
  </main>

<script>
window.addEventListener('DOMContentLoaded',()=>{
'use strict';
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');

// === マウス座標を正規化する関数 ===
function getPointer(evt){
  const rect = canvas.getBoundingClientRect();
  const cssX = evt.clientX - rect.left;
  const cssY = evt.clientY - rect.top;
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  return { x: cssX * scaleX, y: cssY * scaleY };
}

// === スナップ関連 ===
let posSnap=true, posGrid=10;
function snapCoord(v){ return posSnap ? Math.round(v/posGrid)*posGrid : v; }
function snapDelta(d){ return posSnap ? Math.round(d/posGrid)*posGrid : d; }

// === テスト用アイテム ===
let items=[{x:200,y:200,r:40,locked:false}];
let selected=new Set();
let dragging=false, dragKind=null, dragOff=null, groupDragAnchor=null, groupInitials=null;

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const [i,it] of items.entries()){
    ctx.beginPath();
    ctx.arc(it.x,it.y,it.r,0,Math.PI*2);
    ctx.fillStyle="#0ea5e9";
    ctx.fill();
    ctx.strokeStyle=selected.has(i)?"orange":"black";
    ctx.lineWidth=2;
    ctx.stroke();
  }
}

// === mousedown ===
canvas.addEventListener('mousedown',e=>{
  const p=getPointer(e);
  // アイテムヒット
  for(let i=items.length-1;i>=0;i--){
    const it=items[i];
    const dx=p.x-it.x, dy=p.y-it.y;
    if(dx*dx+dy*dy<=it.r*it.r){
      selected=new Set([i]);
      dragging=true; dragKind='items';
      groupDragAnchor={x:p.x,y:p.y};
      groupInitials=[...selected].map(idx=>{
        const it=items[idx];
        return {idx, x0:it.x, y0:it.y};
      });
      draw();
      return;
    }
  }
  selected.clear(); draw();
});

// === mousemove ===
canvas.addEventListener('mousemove',e=>{
  if(!dragging||!groupDragAnchor) return;
  const p=getPointer(e);
  const dx=p.x-groupDragAnchor.x, dy=p.y-groupDragAnchor.y;
  for(const s of groupInitials){
    const it=items[s.idx];
    it.x = s.x0 + snapDelta(dx);
    it.y = s.y0 + snapDelta(dy);
  }
  draw();
});

// === mouseup ===
window.addEventListener('mouseup',()=>{
  dragging=false; dragKind=null; groupDragAnchor=null; groupInitials=null;
});

// === 初期描画 ===
draw();
});
</script>
</body>
</html>
