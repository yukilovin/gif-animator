<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drag-Path GIF Animator（△追加／ターゲット形状＆サイズ指定／透明度／円サイズ=黒枠まで）</title>
<style>
  body{margin:0;background:#ffffff;color:#111827;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;height:100vh;display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;box-sizing:border-box}
  aside{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;overflow:auto}
  main{display:flex;flex-direction:column;align-items:center}
  #canvas{background:#ffffff;border:2px solid #000;touch-action:none;display:block;margin-top:10px}
  #timelineWrap{width:100%;max-width:1200px;margin-top:12px;padding:6px;background:#f3f4f6;border-radius:8px;border:1px solid #d1d5db;resize:vertical;overflow:auto;min-height:160px;max-height:40vh}
  #timeline{width:100%;height:220px;display:block;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb}
  .timeline-header{display:flex;gap:8px;align-items:center;justify-content:space-between;font-size:14px;font-weight:bold;color:#111827;margin-bottom:6px}
  .panel{margin-bottom:12px}
  .panel h2{font-size:14px;margin:0 0 6px;color:#374151}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #d1d5db;background:#fff;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px}
  .btn:hover{background:#f3f4f6}
  input[type="number"], input[type="text"], select{width:90px;padding:2px 4px;font-size:12px}
  input[type="color"]{width:40px;height:24px;padding:0;border:none;background:transparent}
  label{font-size:12px;color:#374151;display:flex;align-items:center;gap:6px}
  .pill{font-size:12px;color:#1f2937;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;margin-left:4px}
  .muted{color:#6b7280;font-size:12px}
  progress{width:100%}
</style>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
  <aside>
    <h1>設定メニュー</h1>

    <div class="panel">
      <h2>アイテム追加</h2>
      <div class="row">
        <button class="btn" id="addIconBtn">＋ アイコン</button>
        <button class="btn" id="addCircleBtn">＋ ○ 円</button>
        <button class="btn" id="addRectBtn">＋ □ 四角</button>
        <button class="btn" id="addTriangleBtn">＋ △ 三角</button>
        <button class="btn" id="addTextRectBtn">＋ 囲み＋テキスト</button>
        <button class="btn" id="resetIconsBtn">↺ 初期8アイコン</button>
        <button class="btn" id="deleteItemBtn">🗑 選択削除</button>
      </div>
    </div>

    <div class="panel">
      <h2>選択アイテム属性</h2>
      <div class="row"><label>名称 <input id="propName" type="text"></label></div>
      <div class="row"><label>サイズ/半径 <input id="propSize" type="number" value="40" min="1" max="540"></label><span class="muted">○は半径、□/△は外接半径</span></div>
      <div class="row"><label>幅 <input id="propW" type="number" value="160" min="10" max="4096"></label><label>高 <input id="propH" type="number" value="90" min="10" max="4096"></label></div>
      <div class="row"><label>透明度 <input id="propAlpha" type="number" value="1" min="0.1" max="1" step="0.05"></label></div>
      <div class="row"><label>テキスト <input id="propText" type="text" placeholder="テキスト"></label></div>
      <div class="row">
  <label>塗り 
    <input id="propFill" type="color" value="#0ea5e9">
    <input type="checkbox" id="noFill"> なし
  </label>
  <label>枠 <input id="propStroke" type="color" value="#111111"></label>
  <label>文字 <input id="propTextColor" type="color" value="#111111"></label>
</div>
      <div class="row">
        <label>フォント <select id="propFont">
          <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial">System</option>
          <option value="'Noto Sans JP', system-ui">Noto Sans JP</option>
          <option value="'Yu Gothic', 'Hiragino Kaku Gothic ProN', Meiryo, system-ui">游ゴシック</option>
          <option value="Roboto, system-ui">Roboto</option>
          <option value="serif">Serif</option>
          <option value="monospace">Monospace</option>
        </select></label>
        <label>文字サイズ <input id="propFontSize" type="number" value="20" min="8" max="240"></label>
      </div>
      <div class="row"><button class="btn" id="applyProps">適用</button></div>
    </div>
<div class="panel">
  <h2>表示順序</h2>
  <div class="row">
    <button class="btn" id="bringFront">最前面</button>
    <button class="btn" id="sendBack">最背面</button>
    <button class="btn" id="bringForward">前へ</button>
    <button class="btn" id="sendBackward">後ろへ</button>
  </div>
</div>
    <div class="panel">
      <h2>キーフレーム</h2>
      <div class="row"><button class="btn" id="addKF">＋ KF追加（現在時刻）</button><button class="btn" id="delKF">－ KF削除（最後）</button><button class="btn" id="clearKF">⌫ 全KF削除</button></div>
      <div class="row"><label><input type="checkbox" id="snapKeys" checked> スナップ</label><span class="pill">間隔 <input type="number" id="snapStep" value="0.10" step="0.01" style="width:60px">s</span></div>
    </div>

    <div class="panel">
      <h2>タイムライン</h2>
      <div class="row"><label>表示高(px) <input type="number" id="tlViewportH" value="220" min="140" max="600"></label><label>横ズーム <input type="range" id="tlZoom" min="0.25" max="4" step="0.01" value="1"></label><label>全体秒数 <input type="number" id="duration" value="8" min="1" max="120"></label></div>
      <div class="row"><span class="pill">Ctrl+ホイール：横ズーム ／ 中/右ドラッグ：横パン ／ 縦スクロール：レーンスクロール</span></div>
    </div>

    <div class="panel">
      <h2>ビュー操作（キャンバス）</h2>
      <div class="row"><button class="btn" id="fitView">↙↗ フィット</button><button class="btn" id="centerIcons">◎ アイテム中央</button><button class="btn" id="resetView">⟲ リセット</button></div>
      <div class="row"><span class="pill">ズーム：ホイール</span><span class="pill">パン：右/中 or Space+ドラッグ</span></div>
    </div>

    <div class="panel">
      <h2>キャンバスサイズ（作業スペース）</h2>
      <div class="row">
        <label>幅(px) <input id="canvasW" type="number" value="1080" min="64" max="4096"></label>
        <label>高(px) <input id="canvasH" type="number" value="1080" min="64" max="4096"></label>
        <label><input type="checkbox" id="lockAspect" checked> 縦横比を維持</label>
        <button class="btn" id="applyCanvasSize">適用</button>
      </div>
      <div class="row"><span class="pill">※ ここは編集用キャンバスの大きさ（見やすさ優先）。</span></div>
    </div>

    <div class="panel">
      <h2>フレーム（枠）サイズ＝GIF出力サイズ</h2>
      <div class="row">
        <label>幅(px) <input id="frameW" type="number" value="1080" min="64" max="4096"></label>
        <label>高(px) <input id="frameH" type="number" value="1080" min="64" max="4096"></label>
        <label><input type="checkbox" id="lockFrameAspect" checked> 比率維持</label>
        <button class="btn" id="applyFrameSize">適用</button>
      </div>
      <div class="row"><span class="pill">※ このサイズが黒枠の内側 & GIF の解像度になります。</span></div>
    </div>

    <div class="panel">
      <h2>書き出し（GIF）</h2>
      <div class="row">
        <label>FPS <input id="expFps" type="number" value="20" min="1" max="60"></label>
        <label>スケール <input id="expScale" type="number" value="1" min="0.25" max="2" step="0.05"></label>
        <label>開始s <input id="expStart" type="number" value="0" min="0"></label>
        <label>終了s <input id="expEnd" type="number" value="8" min="0"></label>
      </div>
      <div class="row">
        <button class="btn" id="exportGifBtn">🎞 GIF書き出し</button>
        <span id="exportStatus" class="muted">準備中…</span>
      </div>
      <div class="row" style="width:100%"><progress id="exportProgress" max="1" value="0"></progress></div>
    </div>
  </aside>

  <main>
    <h1>GIF Animator</h1>
    <canvas id="canvas" width="1080" height="1080"></canvas>
    <div id="timelineWrap">
      <div class="timeline-header">
        <span>▼ タイムライン ▼</span>
        <span style="font-weight:normal">時刻: <span id="timeLabel">0.00</span>s  <button class="btn" id="playBtn">▶</button> <button class="btn" id="pauseBtn">⏸</button> <button class="btn" id="resetTimeBtn">↺</button></span>
      </div>
      <canvas id="timeline"></canvas>
    </div>
  </main>

<script>
// ====== 回転を含む位置・角度補間 ======
function getStateAtTime(it, t){
  const k = it.keys || [];
  if(!k.length) return { x: it.pos.x, y: it.pos.y, rot: (it.rotation||0) };

  if(t <= k[0].t) return { x:k[0].x, y:k[0].y, rot:(k[0].rot??(it.rotation||0)) };
  if(t >= k[k.length-1].t) return { x:k[k.length-1].x, y:k[k.length-1].y, rot:(k[k.length-1].rot??(it.rotation||0)) };

  const norm = a => ((a%360)+360)%360;
  const lerp = (a,b,u)=> a+(b-a)*u;
  const lerpAngle = (a,b,u)=>{
    a = norm(a); b = norm(b);
    let d = b - a;
    if(d > 180) d -= 360;
    if(d < -180) d += 360;
    return norm(a + d*u);
  };

  for(let i=0;i<k.length-1;i++){
    const A=k[i], B=k[i+1];
    if(A.t <= t && t <= B.t){
      const u=(t-A.t)/Math.max(1e-6,B.t-A.t);
      return {
        x: lerp(A.x, B.x, u),
        y: lerp(A.y, B.y, u),
        rot: lerpAngle(A.rot??0, B.rot??0, u)
      };
    }
  }
  return { x: it.pos.x, y: it.pos.y, rot: it.rotation||0 };
}

// ====== キーフレーム追加（回転込み） ======
function addKeyAtNow(it){
  const eps=1/120;
  const idx = it.keys.findIndex(k=>Math.abs(k.t - tNow) < eps);
  const st = getStateAtTime(it, tNow);
  if(idx>=0){
    it.keys[idx].x = st.x;
    it.keys[idx].y = st.y;
    it.keys[idx].rot = st.rot;
  } else {
    it.keys.push({ t:tNow, x:st.x, y:st.y, rot:st.rot });
    it.keys.sort((a,b)=>a.t-b.t);
  }
}

// ====== 描画（回転対応） ======
function draw(){
  drawFrame();
  drawTargets();
  items.forEach(it=>{
    const st = getStateAtTime(it,tNow);
    it.pos.x = st.x; it.pos.y = st.y; it.rotation = st.rot;
    drawItem(it, st);
  });
}

function drawItem(it, pos){
  const s=1/view.scale;
  ctx.save();
  ctx.globalAlpha = it.alpha==null?1:it.alpha;

  // 回転適用
  const angle = (pos.rot||0) * Math.PI/180;
  ctx.translate(pos.x, pos.y);
  ctx.rotate(angle);
  ctx.translate(-pos.x, -pos.y);

  if(it.type==='icon'||it.type==='circle'){
    const r=it.r||40;
    ctx.beginPath();
    ctx.arc(pos.x,pos.y,r,0,Math.PI*2);
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fill(); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.stroke(); }
    const label=(it.text&&it.text.length?it.text:it.name)||'';
    ctx.fillStyle=it.textColor||'#fff';
    ctx.font=(Math.max(8,it.fontSize||20)*s)+'px '+(it.font||'ui-monospace');
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    wrapFillText(ctx,label,pos.x,pos.y,r*1.6*s,Math.max(8,(it.fontSize||20))*1.2*s);
  }
  else if(it.type==='triangle'){
    const r=it.r||40;
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y - r);
    ctx.lineTo(pos.x + r, pos.y + r);
    ctx.lineTo(pos.x - r, pos.y + r);
    ctx.closePath();
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fill(); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.stroke(); }
    ctx.fillStyle=it.textColor||'#fff';
    ctx.font=(Math.max(8,it.fontSize||20)*s)+'px '+(it.font||'system-ui');
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(it.text||it.name||'△', pos.x, pos.y);
  }
  else if(it.type==='rect'){
    const w=it.w||160, h=it.h||90;
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fillRect(pos.x-w/2,pos.y-h/2,w,h); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.strokeRect(pos.x-w/2,pos.y-h/2,w,h); }
  }
  else if(it.type==='textRect'){
    const w=it.w||220, h=it.h||120;
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fillRect(pos.x-w/2,pos.y-h/2,w,h); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.strokeRect(pos.x-w/2,pos.y-h/2,w,h); }
    ctx.fillStyle=it.textColor||'#111';
    ctx.font=(Math.max(8,it.fontSize||20)*s)+'px '+(it.font||'system-ui');
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const lines=(it.text||'テキスト').split('\n');
    lines.forEach((ln,i)=> ctx.fillText(ln, pos.x, pos.y+(i-(lines.length-1)/2)*(Math.max(8,(it.fontSize||20))*1.2*s)));
  }

  ctx.restore();
}

// ====== プロパティパネル対応（回転） ======
function syncPropPanel(){
  const it=items[activeIndex];
  if(!it) return;
  updateSizeMax();
  propName.value=it.name||'';
  propSize.value=it.r||40;
  propW.value=it.w||160;
  propH.value=it.h||90;
  propAlpha.value=(it.alpha==null?1:it.alpha);
  propText.value=it.text||'';
  propFill.value=(it.fill!=null?it.fill:'#000000');
  noFill.checked=(it.fill==null);
  propStroke.value=it.stroke||'#111111';
  propTextColor.value=it.textColor||'#111111';
  propFont.value=it.font||'system-ui';
  propFontSize.value=it.fontSize||20;
  const stNow = getStateAtTime(it, tNow);
  propRotation.value = stNow.rot ?? (it.rotation||0);
}

document.getElementById('applyProps').onclick=()=>{
  const it=items[activeIndex];
  if(!it) return;
  pushUndo();
  const maxR=Math.min(W,H)/2;
  it.name=propName.value||it.name;
  it.r=Math.max(1, Math.min(maxR, parseFloat(propSize.value)||it.r));
  it.w=Math.max(10, Math.min(4096, parseFloat(propW.value)||it.w));
  it.h=Math.max(10, Math.min(4096, parseFloat(propH.value)||it.h));
  it.alpha=Math.max(0.1, Math.min(1, parseFloat(propAlpha.value)||1));
  it.text=propText.value||it.text;
  it.fill = noFill.checked ? null : (propFill.value||it.fill);
  it.stroke=propStroke.value||it.stroke;
  it.textColor=propTextColor.value||it.textColor;
  it.font=propFont.value||it.font;
  it.fontSize=Math.max(8, Math.min(240, parseFloat(propFontSize.value)||it.fontSize));
  it.rotation = parseFloat(propRotation.value)||0;
  // 現在のキーがあれば回転も更新
  const eps=1/120;
  const i = it.keys.findIndex(k=>Math.abs(k.t - tNow) < eps);
  if(i>=0) it.keys[i].rot = it.rotation;
  draw(); drawTimeline();
};


</script>
</body>
</html>
