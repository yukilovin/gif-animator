<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Drag-Path GIF Animatorï¼ˆâ–³è¿½åŠ ï¼ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå½¢çŠ¶ï¼†ã‚µã‚¤ã‚ºæŒ‡å®šï¼é€æ˜åº¦ï¼å††ã‚µã‚¤ã‚º=é»’æ ã¾ã§ï¼‰</title>
<style>
  body{margin:0;background:#ffffff;color:#111827;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;height:100vh;display:grid;grid-template-columns:360px 1fr;gap:12px;padding:12px;box-sizing:border-box}
  aside{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px;overflow:auto}
  main{display:flex;flex-direction:column;align-items:center}
  #canvas{background:#ffffff;border:2px solid #000;touch-action:none;display:block;margin-top:10px}
  #timelineWrap{width:100%;max-width:1200px;margin-top:12px;padding:6px;background:#f3f4f6;border-radius:8px;border:1px solid #d1d5db;resize:vertical;overflow:auto;min-height:160px;max-height:40vh}
  #timeline{width:100%;height:220px;display:block;border:1px solid #e5e7eb;border-radius:6px;background:#f9fafb}
  .timeline-header{display:flex;gap:8px;align-items:center;justify-content:space-between;font-size:14px;font-weight:bold;color:#111827;margin-bottom:6px}
  .panel{margin-bottom:12px}
  .panel h2{font-size:14px;margin:0 0 6px;color:#374151}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:6px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid #d1d5db;background:#fff;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px}
  .btn:hover{background:#f3f4f6}
  input[type="number"], input[type="text"], select{width:90px;padding:2px 4px;font-size:12px}
  input[type="color"]{width:40px;height:24px;padding:0;border:none;background:transparent}
  label{font-size:12px;color:#374151;display:flex;align-items:center;gap:6px}
  .pill{font-size:12px;color:#1f2937;border:1px solid #d1d5db;border-radius:999px;padding:2px 8px;margin-left:4px}
  .muted{color:#6b7280;font-size:12px}
  progress{width:100%}
</style>
<script src="https://unpkg.com/gif.js@0.2.0/dist/gif.js"></script>
</head>
<body>
  <aside>
    <h1>è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>

    <div class="panel">
      <h2>ã‚¢ã‚¤ãƒ†ãƒ è¿½åŠ </h2>
      <div class="row">
        <button class="btn" id="addIconBtn">ï¼‹ ã‚¢ã‚¤ã‚³ãƒ³</button>
        <button class="btn" id="addCircleBtn">ï¼‹ â—‹ å††</button>
        <button class="btn" id="addRectBtn">ï¼‹ â–¡ å››è§’</button>
        <button class="btn" id="addTriangleBtn">ï¼‹ â–³ ä¸‰è§’</button>
        <button class="btn" id="addTextRectBtn">ï¼‹ å›²ã¿ï¼‹ãƒ†ã‚­ã‚¹ãƒˆ</button>
        <button class="btn" id="resetIconsBtn">â†º åˆæœŸ8ã‚¢ã‚¤ã‚³ãƒ³</button>
        <button class="btn" id="deleteItemBtn">ğŸ—‘ é¸æŠå‰Šé™¤</button>
      </div>
    </div>

    <div class="panel">
      <h2>é¸æŠã‚¢ã‚¤ãƒ†ãƒ å±æ€§</h2>
      <div class="row"><label>åç§° <input id="propName" type="text"></label></div>
      <div class="row"><label>ã‚µã‚¤ã‚º/åŠå¾„ <input id="propSize" type="number" value="40" min="1" max="540"></label><span class="muted">â—‹ã¯åŠå¾„ã€â–¡/â–³ã¯å¤–æ¥åŠå¾„</span></div>
      <div class="row"><label>å¹… <input id="propW" type="number" value="160" min="10" max="4096"></label><label>é«˜ <input id="propH" type="number" value="90" min="10" max="4096"></label></div>
      <div class="row"><label>é€æ˜åº¦ <input id="propAlpha" type="number" value="1" min="0.1" max="1" step="0.05"></label></div>
      <div class="row"><label>ãƒ†ã‚­ã‚¹ãƒˆ <input id="propText" type="text" placeholder="ãƒ†ã‚­ã‚¹ãƒˆ"></label></div>
      <div class="row">
  <label>å¡—ã‚Š 
    <input id="propFill" type="color" value="#0ea5e9">
    <input type="checkbox" id="noFill"> ãªã—
  </label>
  <label>æ  <input id="propStroke" type="color" value="#111111"></label>
  <label>æ–‡å­— <input id="propTextColor" type="color" value="#111111"></label>
</div>
      <div class="row">
        <label>ãƒ•ã‚©ãƒ³ãƒˆ <select id="propFont">
          <option value="system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial">System</option>
          <option value="'Noto Sans JP', system-ui">Noto Sans JP</option>
          <option value="'Yu Gothic', 'Hiragino Kaku Gothic ProN', Meiryo, system-ui">æ¸¸ã‚´ã‚·ãƒƒã‚¯</option>
          <option value="Roboto, system-ui">Roboto</option>
          <option value="serif">Serif</option>
          <option value="monospace">Monospace</option>
        </select></label>
        <label>æ–‡å­—ã‚µã‚¤ã‚º <input id="propFontSize" type="number" value="20" min="8" max="240"></label>
      </div>
      <div class="row"><button class="btn" id="applyProps">é©ç”¨</button></div>
    </div>
<div class="panel">
  <h2>è¡¨ç¤ºé †åº</h2>
  <div class="row">
    <button class="btn" id="bringFront">æœ€å‰é¢</button>
    <button class="btn" id="sendBack">æœ€èƒŒé¢</button>
    <button class="btn" id="bringForward">å‰ã¸</button>
    <button class="btn" id="sendBackward">å¾Œã‚ã¸</button>
  </div>
</div>
    <div class="panel">
      <h2>ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ </h2>
      <div class="row"><button class="btn" id="addKF">ï¼‹ KFè¿½åŠ ï¼ˆç¾åœ¨æ™‚åˆ»ï¼‰</button><button class="btn" id="delKF">ï¼ KFå‰Šé™¤ï¼ˆæœ€å¾Œï¼‰</button><button class="btn" id="clearKF">âŒ« å…¨KFå‰Šé™¤</button></div>
      <div class="row"><label><input type="checkbox" id="snapKeys" checked> ã‚¹ãƒŠãƒƒãƒ—</label><span class="pill">é–“éš” <input type="number" id="snapStep" value="0.10" step="0.01" style="width:60px">s</span></div>
    </div>

    <div class="panel">
      <h2>ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
      <div class="row"><label>è¡¨ç¤ºé«˜(px) <input type="number" id="tlViewportH" value="220" min="140" max="600"></label><label>æ¨ªã‚ºãƒ¼ãƒ  <input type="range" id="tlZoom" min="0.25" max="4" step="0.01" value="1"></label><label>å…¨ä½“ç§’æ•° <input type="number" id="duration" value="8" min="1" max="120"></label></div>
      <div class="row"><span class="pill">Ctrl+ãƒ›ã‚¤ãƒ¼ãƒ«ï¼šæ¨ªã‚ºãƒ¼ãƒ  ï¼ ä¸­/å³ãƒ‰ãƒ©ãƒƒã‚°ï¼šæ¨ªãƒ‘ãƒ³ ï¼ ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ï¼šãƒ¬ãƒ¼ãƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«</span></div>
    </div>

    <div class="panel">
      <h2>ãƒ“ãƒ¥ãƒ¼æ“ä½œï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰</h2>
      <div class="row"><button class="btn" id="fitView">â†™â†— ãƒ•ã‚£ãƒƒãƒˆ</button><button class="btn" id="centerIcons">â— ã‚¢ã‚¤ãƒ†ãƒ ä¸­å¤®</button><button class="btn" id="resetView">âŸ² ãƒªã‚»ãƒƒãƒˆ</button></div>
      <div class="row"><span class="pill">ã‚ºãƒ¼ãƒ ï¼šãƒ›ã‚¤ãƒ¼ãƒ«</span><span class="pill">ãƒ‘ãƒ³ï¼šå³/ä¸­ or Space+ãƒ‰ãƒ©ãƒƒã‚°</span></div>
    </div>

    <div class="panel">
      <h2>ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºï¼ˆä½œæ¥­ã‚¹ãƒšãƒ¼ã‚¹ï¼‰</h2>
      <div class="row">
        <label>å¹…(px) <input id="canvasW" type="number" value="1080" min="64" max="4096"></label>
        <label>é«˜(px) <input id="canvasH" type="number" value="1080" min="64" max="4096"></label>
        <label><input type="checkbox" id="lockAspect" checked> ç¸¦æ¨ªæ¯”ã‚’ç¶­æŒ</label>
        <button class="btn" id="applyCanvasSize">é©ç”¨</button>
      </div>
      <div class="row"><span class="pill">â€» ã“ã“ã¯ç·¨é›†ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å¤§ãã•ï¼ˆè¦‹ã‚„ã™ã•å„ªå…ˆï¼‰ã€‚</span></div>
    </div>

    <div class="panel">
      <h2>ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆæ ï¼‰ã‚µã‚¤ã‚ºï¼GIFå‡ºåŠ›ã‚µã‚¤ã‚º</h2>
      <div class="row">
        <label>å¹…(px) <input id="frameW" type="number" value="1080" min="64" max="4096"></label>
        <label>é«˜(px) <input id="frameH" type="number" value="1080" min="64" max="4096"></label>
        <label><input type="checkbox" id="lockFrameAspect" checked> æ¯”ç‡ç¶­æŒ</label>
        <button class="btn" id="applyFrameSize">é©ç”¨</button>
      </div>
      <div class="row"><span class="pill">â€» ã“ã®ã‚µã‚¤ã‚ºãŒé»’æ ã®å†…å´ & GIF ã®è§£åƒåº¦ã«ãªã‚Šã¾ã™ã€‚</span></div>
    </div>

    <div class="panel">
      <h2>æ›¸ãå‡ºã—ï¼ˆGIFï¼‰</h2>
      <div class="row">
        <label>FPS <input id="expFps" type="number" value="20" min="1" max="60"></label>
        <label>ã‚¹ã‚±ãƒ¼ãƒ« <input id="expScale" type="number" value="1" min="0.25" max="2" step="0.05"></label>
        <label>é–‹å§‹s <input id="expStart" type="number" value="0" min="0"></label>
        <label>çµ‚äº†s <input id="expEnd" type="number" value="8" min="0"></label>
      </div>
      <div class="row">
        <button class="btn" id="exportGifBtn">ğŸ GIFæ›¸ãå‡ºã—</button>
        <span id="exportStatus" class="muted">æº–å‚™ä¸­â€¦</span>
      </div>
      <div class="row" style="width:100%"><progress id="exportProgress" max="1" value="0"></progress></div>
    </div>
  </aside>

  <main>
    <h1>GIF Animator</h1>
    <canvas id="canvas" width="1080" height="1080"></canvas>
    <div id="timelineWrap">
      <div class="timeline-header">
        <span>â–¼ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ â–¼</span>
        <span style="font-weight:normal">æ™‚åˆ»: <span id="timeLabel">0.00</span>s  <button class="btn" id="playBtn">â–¶</button> <button class="btn" id="pauseBtn">â¸</button> <button class="btn" id="resetTimeBtn">â†º</button></span>
      </div>
      <canvas id="timeline"></canvas>
    </div>
  </main>

<script>
// ====== å›è»¢ã‚’å«ã‚€ä½ç½®ãƒ»è§’åº¦è£œé–“ ======
function getStateAtTime(it, t){
  const k = it.keys || [];
  if(!k.length) return { x: it.pos.x, y: it.pos.y, rot: (it.rotation||0) };

  if(t <= k[0].t) return { x:k[0].x, y:k[0].y, rot:(k[0].rot??(it.rotation||0)) };
  if(t >= k[k.length-1].t) return { x:k[k.length-1].x, y:k[k.length-1].y, rot:(k[k.length-1].rot??(it.rotation||0)) };

  const norm = a => ((a%360)+360)%360;
  const lerp = (a,b,u)=> a+(b-a)*u;
  const lerpAngle = (a,b,u)=>{
    a = norm(a); b = norm(b);
    let d = b - a;
    if(d > 180) d -= 360;
    if(d < -180) d += 360;
    return norm(a + d*u);
  };

  for(let i=0;i<k.length-1;i++){
    const A=k[i], B=k[i+1];
    if(A.t <= t && t <= B.t){
      const u=(t-A.t)/Math.max(1e-6,B.t-A.t);
      return {
        x: lerp(A.x, B.x, u),
        y: lerp(A.y, B.y, u),
        rot: lerpAngle(A.rot??0, B.rot??0, u)
      };
    }
  }
  return { x: it.pos.x, y: it.pos.y, rot: it.rotation||0 };
}

// ====== ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ãƒ è¿½åŠ ï¼ˆå›è»¢è¾¼ã¿ï¼‰ ======
function addKeyAtNow(it){
  const eps=1/120;
  const idx = it.keys.findIndex(k=>Math.abs(k.t - tNow) < eps);
  const st = getStateAtTime(it, tNow);
  if(idx>=0){
    it.keys[idx].x = st.x;
    it.keys[idx].y = st.y;
    it.keys[idx].rot = st.rot;
  } else {
    it.keys.push({ t:tNow, x:st.x, y:st.y, rot:st.rot });
    it.keys.sort((a,b)=>a.t-b.t);
  }
}

// ====== æç”»ï¼ˆå›è»¢å¯¾å¿œï¼‰ ======
function draw(){
  drawFrame();
  drawTargets();
  items.forEach(it=>{
    const st = getStateAtTime(it,tNow);
    it.pos.x = st.x; it.pos.y = st.y; it.rotation = st.rot;
    drawItem(it, st);
  });
}

function drawItem(it, pos){
  const s=1/view.scale;
  ctx.save();
  ctx.globalAlpha = it.alpha==null?1:it.alpha;

  // å›è»¢é©ç”¨
  const angle = (pos.rot||0) * Math.PI/180;
  ctx.translate(pos.x, pos.y);
  ctx.rotate(angle);
  ctx.translate(-pos.x, -pos.y);

  if(it.type==='icon'||it.type==='circle'){
    const r=it.r||40;
    ctx.beginPath();
    ctx.arc(pos.x,pos.y,r,0,Math.PI*2);
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fill(); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.stroke(); }
    const label=(it.text&&it.text.length?it.text:it.name)||'';
    ctx.fillStyle=it.textColor||'#fff';
    ctx.font=(Math.max(8,it.fontSize||20)*s)+'px '+(it.font||'ui-monospace');
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    wrapFillText(ctx,label,pos.x,pos.y,r*1.6*s,Math.max(8,(it.fontSize||20))*1.2*s);
  }
  else if(it.type==='triangle'){
    const r=it.r||40;
    ctx.beginPath();
    ctx.moveTo(pos.x, pos.y - r);
    ctx.lineTo(pos.x + r, pos.y + r);
    ctx.lineTo(pos.x - r, pos.y + r);
    ctx.closePath();
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fill(); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.stroke(); }
    ctx.fillStyle=it.textColor||'#fff';
    ctx.font=(Math.max(8,it.fontSize||20)*s)+'px '+(it.font||'system-ui');
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(it.text||it.name||'â–³', pos.x, pos.y);
  }
  else if(it.type==='rect'){
    const w=it.w||160, h=it.h||90;
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fillRect(pos.x-w/2,pos.y-h/2,w,h); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.strokeRect(pos.x-w/2,pos.y-h/2,w,h); }
  }
  else if(it.type==='textRect'){
    const w=it.w||220, h=it.h||120;
    if(it.fill!=null){ ctx.fillStyle=it.fill; ctx.fillRect(pos.x-w/2,pos.y-h/2,w,h); }
    if(it.stroke){ ctx.strokeStyle=it.stroke; ctx.lineWidth=2*s; ctx.strokeRect(pos.x-w/2,pos.y-h/2,w,h); }
    ctx.fillStyle=it.textColor||'#111';
    ctx.font=(Math.max(8,it.fontSize||20)*s)+'px '+(it.font||'system-ui');
    ctx.textAlign='center'; ctx.textBaseline='middle';
    const lines=(it.text||'ãƒ†ã‚­ã‚¹ãƒˆ').split('\n');
    lines.forEach((ln,i)=> ctx.fillText(ln, pos.x, pos.y+(i-(lines.length-1)/2)*(Math.max(8,(it.fontSize||20))*1.2*s)));
  }

  ctx.restore();
}

// ====== ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãƒ‘ãƒãƒ«å¯¾å¿œï¼ˆå›è»¢ï¼‰ ======
function syncPropPanel(){
  const it=items[activeIndex];
  if(!it) return;
  updateSizeMax();
  propName.value=it.name||'';
  propSize.value=it.r||40;
  propW.value=it.w||160;
  propH.value=it.h||90;
  propAlpha.value=(it.alpha==null?1:it.alpha);
  propText.value=it.text||'';
  propFill.value=(it.fill!=null?it.fill:'#000000');
  noFill.checked=(it.fill==null);
  propStroke.value=it.stroke||'#111111';
  propTextColor.value=it.textColor||'#111111';
  propFont.value=it.font||'system-ui';
  propFontSize.value=it.fontSize||20;
  const stNow = getStateAtTime(it, tNow);
  propRotation.value = stNow.rot ?? (it.rotation||0);
}

document.getElementById('applyProps').onclick=()=>{
  const it=items[activeIndex];
  if(!it) return;
  pushUndo();
  const maxR=Math.min(W,H)/2;
  it.name=propName.value||it.name;
  it.r=Math.max(1, Math.min(maxR, parseFloat(propSize.value)||it.r));
  it.w=Math.max(10, Math.min(4096, parseFloat(propW.value)||it.w));
  it.h=Math.max(10, Math.min(4096, parseFloat(propH.value)||it.h));
  it.alpha=Math.max(0.1, Math.min(1, parseFloat(propAlpha.value)||1));
  it.text=propText.value||it.text;
  it.fill = noFill.checked ? null : (propFill.value||it.fill);
  it.stroke=propStroke.value||it.stroke;
  it.textColor=propTextColor.value||it.textColor;
  it.font=propFont.value||it.font;
  it.fontSize=Math.max(8, Math.min(240, parseFloat(propFontSize.value)||it.fontSize));
  it.rotation = parseFloat(propRotation.value)||0;
  // ç¾åœ¨ã®ã‚­ãƒ¼ãŒã‚ã‚Œã°å›è»¢ã‚‚æ›´æ–°
  const eps=1/120;
  const i = it.keys.findIndex(k=>Math.abs(k.t - tNow) < eps);
  if(i>=0) it.keys[i].rot = it.rotation;
  draw(); drawTimeline();
};


</script>
</body>
</html>
